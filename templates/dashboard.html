<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­ç½‘æµé‡åˆ†æ - ä»ªè¡¨æ¿</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            background: #f5f7fa;
            padding: 20px 0;
        }
        .navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .navbar-brand {
            font-weight: bold;
            color: #667eea !important;
            font-size: 20px;
        }
        .page-title {
            color: #333;
            font-weight: bold;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .stat-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 4px solid #667eea;
        }
        .summary-card .label {
            color: #999;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        .summary-card .value {
            color: #333;
            font-size: 20px;
            font-weight: bold;
        }
        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .chart-card h5 {
            color: #333;
            font-weight: bold;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        .chart-container {
            position: relative;
            height: 400px;
        }
        .chart-lg {
            height: 450px;
        }
        .table-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .table-card h5 {
            color: #333;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .table-card table {
            margin: 0;
        }
        .table-card th {
            background: #f8f9fa;
            color: #666;
            font-weight: 600;
            border-top: none;
        }
        .table-card td {
            color: #666;
            padding: 12px;
            border-color: #f0f0f0;
        }
        .traffic-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .btn-back {
            background: #667eea;
            color: white;
            text-decoration: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .btn-back:hover {
            background: #764ba2;
            color: white;
            text-decoration: none;
            transform: translateY(-2px);
        }
        .section-title {
            color: #333;
            font-weight: bold;
            margin-top: 30px;
            margin-bottom: 20px;
            padding: 10px 0;
            border-left: 4px solid #667eea;
            padding-left: 10px;
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">ğŸŒ æ ¡å›­ç½‘æµé‡åˆ†æ</a>
            <div class="navbar-text">
                <a href="/" class="btn-back">â† è¿”å›é¦–é¡µ</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid" style="max-width: 1400px;">
        <!-- é¡µé¢æ ‡é¢˜ -->
        <div class="page-title">
            <h2>ğŸ“Š åˆ†æä»ªè¡¨æ¿</h2>
            <p style="color: #999; margin-bottom: 0; font-size: 14px;">å®æ—¶æµé‡åˆ†æä¸å¯è§†åŒ–</p>
        </div>

        <!-- ç»Ÿè®¡æ‘˜è¦ -->
        <div class="stat-summary">
            <div class="summary-card">
                <div class="label">æ€»æµé‡</div>
                <div class="value">{{ total_traffic.total_bytes | format_bytes }}</div>
            </div>
            <div class="summary-card">
                <div class="label">æµé‡åŒ…</div>
                <div class="value">{{ total_traffic.total_packets }}</div>
            </div>
            <div class="summary-card">
                <div class="label">æ´»è·ƒç”¨æˆ·</div>
                <div class="value">{{ total_traffic.unique_users }}</div>
            </div>
            <div class="summary-card">
                <div class="label">IP æ•°é‡</div>
                <div class="value">{{ total_traffic.unique_ips }}</div>
            </div>
        </div>

        <!-- æµé‡è¶‹åŠ¿å›¾ -->
        <div class="chart-card">
            <h5>ğŸ“ˆ æµé‡è¶‹åŠ¿åˆ†æ</h5>
            <div class="chart-container">
                {{ charts_html.traffic_trend | safe }}
            </div>
        </div>

        <!-- æ´»è·ƒæ—¶æ®µå›¾ -->
        <div class="chart-card">
            <h5>â° æ´»è·ƒæ—¶æ®µåˆ†æ</h5>
            <div class="chart-container chart-lg">
                {{ charts_html.active_hours | safe }}
            </div>
        </div>

        <div class="section-title">åº”ç”¨ç±»åˆ«åˆ†æ</div>
        
        <!-- è¡Œå¸ƒå±€ï¼šåº”ç”¨ç±»åˆ«é¥¼å›¾ + æµé‡è¡¨æ ¼ -->
        <div class="row">
            <div class="col-lg-6">
                <div class="chart-card">
                    <h5>ğŸ° åº”ç”¨ç±»åˆ«æµé‡åˆ†å¸ƒ</h5>
                    <div class="chart-container">
                        {{ charts_html.app_category | safe }}
                    </div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="table-card">
                    <h5>ğŸ“Š åº”ç”¨ç±»åˆ«è¯¦æƒ…</h5>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>åº”ç”¨ç±»åˆ«</th>
                                <th class="text-right">æµé‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in app_category %}
                            <tr>
                                <td>{{ item.category }}</td>
                                <td class="text-right"><span class="traffic-badge">{{ item.bytes | format_bytes }}</span></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="section-title">ç”¨æˆ·æµé‡åˆ†æ</div>

        <!-- ç”¨æˆ·æ’è¡Œ -->
        <div class="row">
            <div class="col-lg-8">
                <div class="chart-card">
                    <h5>ğŸ‘¥ ç”¨æˆ·æµé‡æ’è¡Œ TOP 15</h5>
                    <div class="chart-container chart-lg">
                        {{ charts_html.user_ranking | safe }}
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="table-card">
                    <h5>ğŸ† ç”¨æˆ·æ’è¡Œ</h5>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>æ’å</th>
                                <th>ç”¨æˆ·</th>
                                <th class="text-right">æµé‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in user_ranking[:10] %}
                            <tr>
                                <td><strong>#{{ loop.index }}</strong></td>
                                <td>{{ item.user }}</td>
                                <td class="text-right">
                                    <span class="traffic-badge">{{ item.bytes | format_bytes }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- æ´»è·ƒæ—¶æ®µè¡¨æ ¼ -->
        <div class="section-title">æŒ‰å°æ—¶ç»Ÿè®¡</div>
        <div class="table-card">
            <h5>â±ï¸ æ¯å°æ—¶æµé‡ç»Ÿè®¡</h5>
            <table class="table table-sm table-hover">
                <thead>
                    <tr>
                        <th>æ—¶é—´</th>
                        <th>æ´»è·ƒç”¨æˆ·</th>
                        <th>æµé‡åŒ…æ•°</th>
                        <th class="text-right">æ€»æµé‡</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in active_hours %}
                    <tr>
                        <td><strong>{{ item.hour }}</strong></td>
                        <td>{{ item.active_users }}</td>
                        <td>{{ item.packet_count }}</td>
                        <td class="text-right"><span class="traffic-badge">{{ item.total_bytes | format_bytes }}</span></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- ç”¨æˆ·ç”»åƒåˆ†æéƒ¨åˆ† -->
        <div class="section-title">ğŸ‘¤ ç”¨æˆ·ç”»åƒåˆ†æ</div>
        
        <!-- ç”¨æˆ·æ ‡ç­¾å¡ç‰‡ -->
        <div id="user-tags-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
            <!-- åŠ¨æ€åŠ è½½ç”¨æˆ·å¡ç‰‡ -->
        </div>

        <!-- ç”¨æˆ·è¯¦æƒ…é¢æ¿ -->
        <div id="user-detail-panel" style="display: none;">
            <div class="chart-card">
                <h5 id="detail-user-name">ç”¨æˆ·è¯¦æƒ…</h5>
                
                <div class="row">
                    <div class="col-lg-6">
                        <div style="position: relative; height: 300px;">
                            <canvas id="user-category-chart"></canvas>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div style="position: relative; height: 300px;">
                            <canvas id="user-protocol-chart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="row" style="margin-top: 20px;">
                    <div class="col-lg-12">
                        <div style="position: relative; height: 250px;">
                            <canvas id="user-hours-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <script>
        let userProfilesData = {};
        let currentUserChart = null;
        let currentProtocolChart = null;
        let currentHoursChart = null;

        // åŠ è½½ç”¨æˆ·ç”»åƒæ•°æ®
        function loadUserProfiles() {
            fetch('/api/user_profiles')
                .then(response => response.json())
                .then(data => {
                    userProfilesData = data;
                    renderUserTags();
                })
                .catch(error => console.error('Error loading user profiles:', error));
        }

        // æ¸²æŸ“ç”¨æˆ·æ ‡ç­¾å¡ç‰‡
        function renderUserTags() {
            const container = document.getElementById('user-tags-container');
            container.innerHTML = '';

            Object.entries(userProfilesData).slice(0, 12).forEach(([userId, profile]) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.cssText = 'cursor: pointer; transition: all 0.3s;';
                
                const tagsHtml = profile.tags.map(tag => {
                    let badgeClass = 'badge bg-primary';
                    if (tag.includes('æ¸¸æˆ')) badgeClass = 'badge bg-danger';
                    else if (tag.includes('è§†é¢‘')) badgeClass = 'badge bg-info';
                    else if (tag.includes('ç¤¾äº¤')) badgeClass = 'badge bg-success';
                    else if (tag.includes('å­¦ä¹ ')) badgeClass = 'badge bg-warning';
                    else if (tag.includes('æŠ€æœ¯')) badgeClass = 'badge bg-secondary';
                    else if (tag.includes('å¯ç–‘')) badgeClass = 'badge bg-dark';
                    
                    return `<span class="${badgeClass}" style="margin-right: 5px; margin-bottom: 5px; display: inline-block;">${tag}</span>`;
                }).join('');

                card.innerHTML = `
                    <div class="card-body">
                        <h6 class="card-title">${userId}</h6>
                        <div style="margin-top: 10px;">
                            ${tagsHtml}
                        </div>
                    </div>
                `;

                card.addEventListener('click', () => showUserDetail(userId));
                card.addEventListener('mouseover', () => card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)');
                card.addEventListener('mouseout', () => card.style.boxShadow = '');

                container.appendChild(card);
            });
        }

        // æ˜¾ç¤ºç”¨æˆ·è¯¦æƒ…
        function showUserDetail(userId) {
            const profile = userProfilesData[userId];
            if (!profile) return;

            document.getElementById('user-detail-panel').style.display = 'block';
            document.getElementById('detail-user-name').textContent = `ç”¨æˆ·è¯¦æƒ… - ${userId}`;

            // åº”ç”¨ç±»åˆ«é¥¼å›¾
            renderCategoryChart(profile.category_pct);

            // åè®®å æ¯”é¥¼å›¾
            renderProtocolChart(profile.protocol_ratio);

            // æ´»è·ƒæ—¶æ®µæŸ±çŠ¶å›¾
            renderHoursChart(profile.active_hours);

            // æ»šåŠ¨åˆ°è¯¦æƒ…é¢æ¿
            document.getElementById('user-detail-panel').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // åº”ç”¨ç±»åˆ«å›¾è¡¨
        function renderCategoryChart(categoryData) {
            const ctx = document.getElementById('user-category-chart').getContext('2d');
            
            if (currentUserChart) {
                currentUserChart.destroy();
            }

            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);

            currentUserChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40', '#C9CBCF']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        title: {
                            display: true,
                            text: 'åº”ç”¨ç±»åˆ«å æ¯” (%)'
                        }
                    }
                }
            });
        }

        // åè®®å æ¯”å›¾è¡¨
        function renderProtocolChart(protocolData) {
            const ctx = document.getElementById('user-protocol-chart').getContext('2d');
            
            if (currentProtocolChart) {
                currentProtocolChart.destroy();
            }

            const labels = Object.keys(protocolData);
            const data = Object.values(protocolData);

            currentProtocolChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: ['#667eea', '#764ba2', '#f093fb']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        title: {
                            display: true,
                            text: 'åè®®å æ¯” (%)'
                        }
                    }
                }
            });
        }

        // æ´»è·ƒæ—¶æ®µæŸ±çŠ¶å›¾
        function renderHoursChart(hoursData) {
            const ctx = document.getElementById('user-hours-chart').getContext('2d');
            
            if (currentHoursChart) {
                currentHoursChart.destroy();
            }

            const hours = Array.from({length: 24}, (_, i) => i);
            const data = hours.map(h => {
                return hoursData[h]?.bytes || 0;
            });

            currentHoursChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: hours.map(h => `${String(h).padStart(2, '0')}:00`),
                    datasets: [{
                        label: 'æµé‡ (å­—èŠ‚)',
                        data: data,
                        backgroundColor: '#667eea',
                        borderColor: '#667eea',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        title: {
                            display: true,
                            text: 'æ¯å°æ—¶æ´»è·ƒåº¦'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return (value / (1024 * 1024)).toFixed(1) + ' MB';
                                }
                            }
                        }
                    }
                }
            });
        }

        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        document.addEventListener('DOMContentLoaded', loadUserProfiles);
    </script>
</body>
</html>
